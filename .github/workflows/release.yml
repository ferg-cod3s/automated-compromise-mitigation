name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  security-check:
    name: Pre-Release Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@0c52d547c9bc32b1aa3301fd7a9cb496313a4491 # v5.0.0
        with:
          go-version: '1.22'
          cache: true

      - name: Run security scans
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -fmt=json -out=gosec-results.json ./...

      - name: Vulnerability check
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  release:
    name: Create Release
    needs: security-check
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@0c52d547c9bc32b1aa3301fd7a9cb496313a4491 # v5.0.0
        with:
          go-version: '1.22'
          cache: true

      - name: Run tests
        run: go test -v ./...

      - name: Install GoReleaser
        uses: goreleaser/goreleaser-action@7ec5c2b0c6caec3c5e6e4a1c5f8a5a2b6c4b6d4f # v5.0.0
        with:
          install-only: true
          version: latest

      - name: Run GoReleaser
        run: goreleaser release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate SBOM
        run: |
          go install github.com/anchore/syft/cmd/syft@latest

          # Generate SBOM for each binary
          mkdir -p dist/sbom

          for binary in dist/acm-service_* dist/acm-cli_*; do
            if [ -f "$binary" ]; then
              basename=$(basename "$binary")
              syft "$binary" -o spdx-json > "dist/sbom/${basename}-sbom.json"
              syft "$binary" -o cyclonedx-json > "dist/sbom/${basename}-bom.json"
            fi
          done

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: sbom
          path: dist/sbom/
          retention-days: 90

      - name: Sign release artifacts
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          # Placeholder for GPG signing
          # TODO: Implement GPG signing when keys are configured
          echo "GPG signing will be implemented when keys are configured"
          echo "For now, checksums are generated by GoReleaser"

  publish-checksums:
    name: Publish Release Checksums
    needs: release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Download release artifacts
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427 # v4.1.4
        with:
          path: dist

      - name: Generate additional checksums
        run: |
          cd dist

          # Generate SHA-512 checksums
          find . -type f -name "*.tar.gz" -o -name "*.zip" | while read file; do
            sha512sum "$file" >> checksums-sha512.txt
          done

          # Generate SHA-256 checksums (GoReleaser already does this, but for completeness)
          find . -type f -name "*.tar.gz" -o -name "*.zip" | while read file; do
            sha256sum "$file" >> checksums-sha256.txt
          done

      - name: Upload checksums
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: checksums
          path: dist/checksums-*.txt
          retention-days: 90

  docker-build:
    name: Build Docker Images
    needs: security-check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb # v3.3.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20 # v3.1.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@8e5442c4ef9f78752691e2d8f8d19755c6f78e81 # v5.5.1
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha

      - name: Build and push Docker image
        uses: docker/build-push-action@2cdde995de11925a030ce8070c3d77a52ffcf1c0 # v5.3.0
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ github.ref_name }}
            COMMIT=${{ github.sha }}
            BUILD_DATE=${{ github.event.repository.updated_at }}

  release-notes:
    name: Generate Release Notes
    needs: release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: '.github/release-changelog-config.json'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release with changelog
        uses: softprops/action-gh-release@9d7c94cfd0a1f3ed45544c887983e9fa900f0564 # v2.0.4
        with:
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-audit:
    name: Post-Release Security Audit
    needs: release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Run Trivy scan on release
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-release-results.sarif'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@012739e5082ff0c22ca6d6ab32e07c36df03c4a4 # v3.22.12
        with:
          sarif_file: trivy-release-results.sarif

      - name: Create security audit summary
        run: |
          echo "## ðŸ”’ Release Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Security scans completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… SBOM generated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Checksums published" >> $GITHUB_STEP_SUMMARY
